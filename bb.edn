{:tasks
 {:requires ([babashka.fs :as fs])
  clean (fs/delete-tree "out")
  watch (do (shell "npx shadow-cljs --force-spawn watch modules"))
  compile (do (shell "npx shadow-cljs --force-spawn compile modules")
              #_#_#_(spit "out/nbb_core.js"
                    (clojure.string/replace (slurp "out/nbb_core.js") (re-pattern "self") "globalThis"))
              (spit "out/nbb_main.js"
                    (str "#!/usr/bin/env node\n\n" (slurp "out/nbb_main.js")))
              (shell "chmod +x out/nbb_main.js"))
  release {:depends [clean]
           :task
           (do (shell "npx shadow-cljs --force-spawn release modules")
               (spit "out/nbb_core.js"
                     (clojure.string/replace (slurp "out/nbb_core.js") (re-pattern "self") "globalThis"))
               (spit "out/nbb_main.js"
                     (str "#!/usr/bin/env node\n\n" (slurp "out/nbb_main.js")))
               (shell "chmod +x out/nbb_main.js"))}
  run (shell "out/nbb_main.js test.cljs")
  publish {:depends [release]
           :task (shell "npm publish")}}}
